services:
  db:
    image: postgres:16-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-planificador}-db
    restart: unless-stopped
    
    labels:
      - "com.utec.project=planificador-docente"
      - "com.utec.component=database"
      - "com.utec.environment=development"
    
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    networks:
      - app-network
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: ${DB_HEALTHCHECK_INTERVAL:-10s}
      timeout: ${DB_HEALTHCHECK_TIMEOUT:-5s}
      retries: ${DB_HEALTHCHECK_RETRIES:-5}
      start_period: ${DB_HEALTHCHECK_START_PERIOD:-10s}

  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - GRADLE_OPTS=-Dorg.gradle.daemon=false
    
    container_name: ${COMPOSE_PROJECT_NAME:-planificador}-app
    restart: unless-stopped
    
    labels:
      - "com.utec.project=planificador-docente"
      - "com.utec.component=backend-api"
      - "com.utec.environment=development"
      - "com.utec.framework=spring-boot"
      - "com.utec.version=1.0.0"
    
    depends_on:
      db:
        condition: service_healthy
    
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      
      DATABASE_URL: jdbc:postgresql://db:5432/${POSTGRES_DB}
      DATABASE_USERNAME: ${POSTGRES_USER}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      
      JPA_DDL_AUTO: ${JPA_DDL_AUTO:-update}
      HIBERNATE_BATCH_SIZE: ${HIBERNATE_BATCH_SIZE:-20}
      
      HIKARI_MAX_POOL_SIZE: ${HIKARI_MAX_POOL_SIZE:-10}
      HIKARI_MIN_IDLE: ${HIKARI_MIN_IDLE:-5}
      HIKARI_CONNECTION_TIMEOUT: ${HIKARI_CONNECTION_TIMEOUT:-30000}
      HIKARI_IDLE_TIMEOUT: ${HIKARI_IDLE_TIMEOUT:-600000}
      HIKARI_MAX_LIFETIME: ${HIKARI_MAX_LIFETIME:-1800000}
      
      SERVER_PORT: ${SERVER_PORT:-8080}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:4200}
      
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
      JWT_ISSUER: ${JWT_ISSUER:-UTEC-Planificador}
      AUTH_DEFAULT_PROVIDER: ${AUTH_DEFAULT_PROVIDER:-LOCAL}
      
      LDAP_ENABLED: ${LDAP_ENABLED:-false}
      LDAP_URL: ${LDAP_URL:-ldap://ldap:389}
      LDAP_BASE: ${LDAP_BASE:-dc=utec,dc=edu,dc=uy}
      LDAP_USER_DN_PATTERN: ${LDAP_USER_DN_PATTERN:-uid={0},ou=people}
      LDAP_USER_SEARCH_FILTER: ${LDAP_USER_SEARCH_FILTER:-(uid={0})}
      LDAP_MANAGER_DN: ${LDAP_MANAGER_DN:-}
      LDAP_MANAGER_PASSWORD: ${LDAP_MANAGER_PASSWORD:-}
      
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_SECURITY_LEVEL: ${LOG_SECURITY_LEVEL:-DEBUG}
      LOG_SPRING_SECURITY: ${LOG_SPRING_SECURITY:-INFO}
      LOG_LDAP: ${LOG_LDAP:-DEBUG}
      LOG_FILE: ${LOG_FILE:-logs/application.log}
      
      LDAP_DEFAULT_CAMPUS_ID: ${LDAP_DEFAULT_CAMPUS_ID:-1}
      
      JAVA_OPTS: ${JAVA_OPTS:-}
    
    ports:
      - "${APP_PORT:-8080}:8080"
    
    networks:
      - app-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/actuator/health"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-40s}

  ldap:
    profiles: ["ldap"]
    image: osixia/openldap:1.5.0
    container_name: ${COMPOSE_PROJECT_NAME:-planificador}-ldap
    hostname: ldap.utec.edu.uy
    restart: unless-stopped
    
    labels:
      - "com.utec.project=planificador-docente"
      - "com.utec.component=ldap-server"
    
    environment:
      LDAP_ORGANISATION: "Universidad Tecnologica del Uruguay"
      LDAP_DOMAIN: "utec.edu.uy"
      LDAP_BASE_DN: "dc=utec,dc=edu,dc=uy"
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD:-admin123}
      LDAP_CONFIG_PASSWORD: ${LDAP_CONFIG_PASSWORD:-config123}
      LDAP_READONLY_USER: "false"
      LDAP_RFC2307BIS_SCHEMA: "true"
      LDAP_BACKEND: "mdb"
      LDAP_TLS: ${LDAP_TLS:-false}
      LDAP_LOG_LEVEL: ${LDAP_LOG_LEVEL:-256}
    
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
    
    networks:
      - app-network
    
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "dc=utec,dc=edu,dc=uy", "-D", "cn=admin,dc=utec,dc=edu,dc=uy", "-w", "${LDAP_ADMIN_PASSWORD:-admin123}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
    name: ${COMPOSE_PROJECT_NAME:-planificador}-postgres-data
  
  ldap_data:
    driver: local
    name: ${COMPOSE_PROJECT_NAME:-planificador}-ldap-data
  
  ldap_config:
    driver: local
    name: ${COMPOSE_PROJECT_NAME:-planificador}-ldap-config
